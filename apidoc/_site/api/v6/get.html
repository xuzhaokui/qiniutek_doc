<!DOCTYPE html>
<html>
	<head>
		<meta name="robots" content="all" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="description" content="七牛云存储API和SDK文档" />
		<meta name="keywords" content="七牛, 七牛云存储, 七牛云存储API, 七牛云存储SDK, qrsync, qboxrsctl, QinuRS, S3" />
		<meta name="author" content="qiniu.com" />
		<meta name="copyright" content="qiniu.com" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Language" content="zh-cn" />
		<meta http-equiv="imagetoolbar" content="false" />
		<meta name="MSSmartTagsPreventParsing" content="true" />
		<title>下载接口 | 七牛云存储</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/gif" />
		<link href="/static/css/reset.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/960.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/uv_active4d.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
	</head>
	<body class="api">
		<div id="header-wrapper">
			<div id="header">
				<div>
					<a class="logo" href="/">七牛云存储</a>
					<ul class="nav">
						<li><a href="https://portal.qiniu.com">开发者平台</a></li>
						<li><a href="http://www.qiniu.com">七牛官网</a></li>
						<!-- <li><a href="/faq/FAQ.html">FAQ</a></li> -->
					</ul>
				</div>
			</div><!-- #header -->
		</div><!-- #header-wrapper -->

		<div id="wrapper">
			<div class="content">	
				<h1>下载接口<span id="version">v6</span></h1>
				<article>
				<ul>
<li><a href="#public-download">公有资源下载</a></li>
<li><a href="#private-download">私有资源下载</a>

<ul>
<li><a href="#download-token">下载授权凭证 - downloadToken</a>

<ul>
<li><a href="#download-token-algorithm">算法</a></li>
</ul></li>
</ul></li>
<li><a href="#download-by-range">断点续下载</a></li>
<li><a href="#define-404-not-found">自定义 404 Not Found</a></li>
<li><a href="#define-download-friendly-name">自定义资源下载时所保存的名称</a></li>
</ul>

<p><a name="public-download"></a></p>

<h2>公有资源下载</h2>

<p><strong>格式</strong></p>

<pre><code>[GET] http://&lt;bucket&gt;.qiniudn.com/&lt;key&gt;
</code></pre>

<p><strong>或者</strong></p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;
</code></pre>

<p><strong>或者</strong></p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;?&lt;fop&gt;/&lt;params&gt;
</code></pre>

<p>Qiniu-Cloud-Storage 的云处理（图片/音频/视频）API 满足 <code>url?&lt;fop&gt;/&lt;params&gt;</code> 这种格式，<code>&lt;fop&gt;</code> 表示具体的云处理指令，例如：<code>url?imageView/1/w/480/h/320</code> 表示一个缩略图预览的URL，其中 <code>imageView</code> 是具体的 <code>&lt;fop&gt;</code>, <code>1/w/480/h/320</code> 是该 fop 的 <code>&lt;params&gt;</code>。</p>

<p><strong>参数</strong></p>

<table>
<thead>
<tr>
<td>名称</td>
<td>说明</td>
</tr>
</thead>

<tbody>
<tr>
<td>bucket</td>
<td>空间名称</td>
</tr>

<tr>
<td>key</td>
<td>上传时 App-Client 端指定的文件ID，在指定空间内唯一</td>
</tr>

<tr>
<td>domain</td>
<td>bucket 绑定的自定义域名</td>
</tr>
</tbody>
</table>

<p><strong>流程</strong></p>

<pre><code>          *************
      ****             ****
    **                     **
  **                         **
  *    Qiniu-Cloud-Storage    *
  **                         **
    **                     **
      ****             ****
          *************
              ^  |
              |  |
              |  |
  (1) Request |  |
              |  |
              |  |
              |  |
              |  |
              |  |
              |  |
              |  |
              |  |
              |  | (2) Response
              |  |
              |  |
              |  v
   +-------------------------+
   |                         |
   |                         |
   |                         |
   |        App-Client       |
   |(Web/iOS/Android/etc,...)|
   |                         |
   |                         |
   |                         |
   +-------------------------+
</code></pre>

<ol>
<li>App-Client 访问文件 URL 请求下载资源</li>
<li>Qiniu-Cloud-Storage 响应 App-Client, 命令距离 App-Client 物理距离最近的 IO 节点输出文件内容</li>
<li>Response 过程中支持 <a href="#download-by-range">断点续下载</a></li>
</ol>

<p><a name="private-download"></a></p>

<h2>私有资源下载</h2>

<p><strong>格式</strong></p>

<pre><code>[GET] http://&lt;bucket&gt;.qiniudn.com/&lt;key&gt;?e=&lt;deadline&gt;&amp;token=&lt;downloadToken&gt;
</code></pre>

<p><strong>或者</strong></p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;?e=&lt;deadline&gt;&amp;token=&lt;downloadToken&gt;
</code></pre>

<p><strong>或者</strong></p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;?&lt;fop&gt;/&lt;params&gt;&amp;e=&lt;deadline&gt;&amp;token=&lt;downloadToken&gt;
</code></pre>

<p><strong>参数</strong></p>

<table>
<thead>
<tr>
<td>名称</td>
<td>说明</td>
</tr>
</thead>

<tbody>
<tr>
<td>bucket</td>
<td>空间名称</td>
</tr>

<tr>
<td>key</td>
<td>上传时 App-Client 端指定的文件ID，在指定空间内唯一</td>
</tr>

<tr>
<td>domain</td>
<td>bucket 绑定的自定义域名</td>
</tr>

<tr>
<td>deadline</td>
<td>失效期，标准的Unix timestamp形式，从1970年1月1日（UTC/GMT的午夜）开始到失效期所经过的秒数，过了这个时间点之后，后续请求无效</td>
</tr>

<tr>
<td>downloadToken</td>
<td>下载授权凭证，由 App-Server 根据 <a href="#download-token-algorithm">downloadToken 签名算法</a> 生成并颁发给 App-Client</td>
</tr>
</tbody>
</table>

<p><strong>流程</strong></p>

<pre><code>                                     *************
                                 ****             ****
                               **                     **
                             **                         **
                             *    Qiniu-Cloud-Storage    *
                             **                         **
                               **                     **
                             ^   ****             ****
                            /   /    *************
                           /   /
                          /   /
    (3) Request Download /   /
                        /   /
                       /   /
                      /   /
                     /   /  (4) Return Result
                    /   /
                   /   /
                  /   /
                 /   /
                /   /
               /   /
              /   /
             /   /
            /   v
    +------------------+                                        +------------------+
    |                  |                                        |                  |
    |                  |    (1) Request (can be once)           |                  |
    |                  |---------------------------------------&gt;|                  |
    |    App-Client    |                                        |    App-Server    |
    |                  |&lt;---------------------------------------|                  |
    |                  |    (2) Return DownloadToken            |                  |
    |                  |                                        |                  |
    +------------------+                                        +------------------+
</code></pre>

<ol>
<li>App-Client 向 App-Server 请求下载授权</li>
<li>App-Server 根据 <a href="#download-token-algorithm">downloadToken 签名算法</a> 生成 downloadToken, 并颁发给 App-Client</li>
<li>App-Client 拿到 downloadToken 后，向 Qiniu-Cloud-Storage 请求下载文件</li>
<li>Qiniu-Cloud-Storage 在校验 downloadToken 成功后，输出文件内容。如果校验失败，返错误信息（401 bad token）</li>
<li>Qiniu-Cloud-Storage 输出文件内容过程中支持 <a href="#download-by-range">断点续下载</a></li>
</ol>

<p><a name="download-token"></a></p>

<h2>下载授权凭证 - downloadToken</h2>

<p>针对私有资源访问/下载，必须提供有效的 downloadToken，downloadToken 可以控制
URL 的有效期。</p>

<p><a name="download-token-algorithm"></a></p>

<h3>算法</h3>

<p>downloadToken 算法如下：</p>

<pre><code>// 步骤1：生成不带 token 的下载 URL
url = http://&lt;domain&gt;/&lt;key&gt;?e=&lt;deadline&gt;

// 或者附加 fop 指令的下载 URL
url = http://&lt;domain&gt;/&lt;key&gt;?&lt;fop&gt;/&lt;params&gt;&amp;e=&lt;deadline&gt;

// 步骤2：将 URL 混入 SecretKey 进行数字签名
Signature = hmac_sha1(url, SecretKey)

// 步骤3：将签名摘要值进行安全编码
EncodedSign = urlsafe_base64_encode(Signature)

// 步骤4：连接各字符串，生成下载授权凭证
downloadToken = AccessKey:EncodedSign
</code></pre>

<p><strong>注意</strong></p>

<ul>
<li><code>urlsafe_base64_encode()</code> 函数按照标准的 <a href="http://www.ietf.org/rfc/rfc4648.txt">RFC 4648</a> 实现，开发者可以参考 <a href="https://github.com/qiniu">github.com/qiniu</a> 上各SDK的样例代码。</li>
<li><code>AccessKey:EncodedSign</code> 这里的冒号是字符串，仅作为连接分隔符使用，最终连接组合的 downloadToken 也是一个字符串（String）。</li>
</ul>

<p><a name="download-by-range"></a></p>

<h2>断点续下载</h2>

<p>断点续下载协议标准参考：<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.35">http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.35</a></p>

<p>七牛云存储按以上标准支持断点续下载，只需在 HTTP 请求下载链接的头部附带 <code>Range</code> 字段即可。</p>

<pre><code>Range: bytes=&lt;first-byte-pos&gt;-&lt;last-byte-pos&gt;
</code></pre>

<p><strong>参数</strong></p>

<table>
<thead>
<tr>
<td>名称</td>
<td>说明</td>
</tr>
</thead>

<tbody>
<tr>
<td><code>&lt;first-byte-pos&gt;</code></td>
<td>起始位置，从数字0开始计算</td>
</tr>

<tr>
<td><code>&lt;last-byte-pos&gt;</code></td>
<td>断点续下载中，最后一个字节所在的位置</td>
</tr>
</tbody>
</table>

<p><a name="define-404-not-found"></a></p>

<h2>自定义 404 Not Found</h2>

<p>七牛云存储支持自定义 404 Not Found 处理，当一个资源不存在，可以让该请求命中一个缺省的资源。该资源可以是一张图片，也可以是一段HTML等。</p>

<p>要实现自定义 404 Not Found，只需向指定的 bucket (存储空间) 上传一个 key (FileID) 为 <code>errno-404</code> 的文件即可。</p>

<p><a name="define-download-friendly-name"></a></p>

<h2>自定义资源下载时所保存的名称</h2>

<pre><code>[GET] url?download/&lt;saveAsFriendlyName&gt;
</code></pre>

<p>如上 API 规格，<code>download</code> 是一个 <code>fop</code> 指令，<code>&lt;saveAsFriendlyName&gt;</code> 是该 fop 指令的参数，表示下载资源保存在本地的文件名称，一般建议带上文件后缀。</p>

<p>公有资源下载</p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;?download/&lt;saveAsFriendlyName&gt;
</code></pre>

<p>私有资源下载</p>

<pre><code>[GET] http://&lt;domain&gt;/&lt;key&gt;?download/&lt;saveAsFriendlyName&gt;&amp;e=&lt;deadline&gt;&amp;token=&lt;downloadToken&gt;
</code></pre>

<p><strong>示例</strong></p>

<ul>
<li><a href="http://qiniuphotos.qiniudn.com/gogopher.jpg?download/test.jpg">http://qiniuphotos.qiniudn.com/gogopher.jpg?download/test.jpg</a></li>
</ul>

				</article>
			</div>

			<div id="js-sidebar" class="sidebar-shell">
				<div class="js-toggle-list sidebar-module expandable">
					<ul>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">新手上路</span></h3>
						<ul class="js-guides">
							<li><a href="/guide/testing.html">测试指南</a></li>
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">API</span></h3>
						<ul class="js-guides">
							<li><a href="/api/put.html">上传</a></li>
							<li><a href="/api/get.html">下载</a></li>
							<li><a href="/api/file-handle.html">文件管理</a></li>
							<li><a href="/api/image-process.html">图像处理</a></li>
							<li><a href="/api/audio-video-hls-process.html">音频/视频/流媒体处理</a></li>
							<li><a href="/api/qrcode.html">生成二维码 - QR code</a></li>
							<li><a href="/api/markdown-convert.html">Markdown 转 HTML</a></li>
							<li><a href="/api/pipeline.html">Pipeline API</a></li>
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">SDK</span></h3>
						<ul class="js-guides">
							<li><a href="/ios-sdk/index.html">Objective-C (iOS)</a></li>
							<li><a href="/android-sdk/index.html">Java (Android)</a></li>
							<li><a href="/java-sdk/index.html">Java</a></li>
							<li><a href="/php-sdk/index.html">PHP</a></li>
							<li><a href="/python-sdk/index.html">Python</a></li>
							<li><a href="/ruby-sdk/index.html">Ruby</a></li>
							<li><a href="/nodejs-sdk/index.html">Node.js</a></li>
							<li><a href="/csharp-sdk/index.html">C#</a></li>
							<li><a href="/c-sdk/index.html">C/C++</a></li>
							<li><a href="/go-sdk/index.html">Go</a></li>
							<li><a href="/perl-sdk/index.html">Perl</a></li>							
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">上传及开发调试工具</span></h3>
						<ul class="js-guides">
							<li><a href="/tools/qrsync.html">qrsync</a></li>
							<li><a href="/tools/qboxrsctl.html">qboxrsctl</a></li>
							<li><a href="/tools/qiniu-autosync.html">qiniu-autosync</a></li>
						</ul>
						</li>
					</ul>
				</div> <!-- /sidebar-module -->
				<div class="sidebar-module">
					<p>帮助联系: <a href="mailto:support@qiniu.com">support@qiniu.com</a></p>
				</div>
			</div><!-- /sidebar-shell -->

		</div><!-- #wrapper -->

		<div id="footer" >
			<div class="lower_footer">
				<div class="footer_inner clearfix">
					<p>&copy; <span id="year">2012-2013</span> <a href="/">docs.qiniu.com</a>. All rights reserved. Powerd by <a href="http://www.qiniu.com" target="_blank">七牛云存储</a>. <a href="http://www.miibeian.gov.cn/" target="_blank">沪ICP备11037377号-2</a></p>
				</div><!-- /.site -->
			</div><!-- /.lower_footer -->
		</div><!-- /#footer -->

		<!-- <div class="popover fade top in"><div class="arrow"></div><h3 class="popover-title">下载接口</h3><div id="popover-content"></div></div> -->
		<script src="/static/js/jquery.js" type="text/javascript"></script>
		<script src="/static/js/qiniudoc.js" type="text/javascript"></script>
		<script src="/static/js/jquery.scrollUp.min.js"></script>
		<script type="text/javascript">
			   //var sdkName = "下载接口"
				 //$("#popover-content").html($("article ul")[0].outerHTML)
				 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
					})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

					ga('create', 'UA-40857860-3', 'qiniu.com');
					ga('send', 'pageview');
		 </script>
	 </body>
 </html>
