<!DOCTYPE html>
<html>
	<head>
		<meta name="robots" content="all" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="description" content="七牛云存储API和SDK文档" />
		<meta name="keywords" content="七牛, 七牛云存储, 七牛云存储API, 七牛云存储SDK, qrsync, qboxrsctl, QinuRS, S3" />
		<meta name="author" content="qiniu.com" />
		<meta name="copyright" content="qiniu.com" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Language" content="zh-cn" />
		<meta http-equiv="imagetoolbar" content="false" />
		<meta name="MSSmartTagsPreventParsing" content="true" />
		<title>文件管理接口 | 七牛云存储</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/gif" />
		<link href="/static/css/reset.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/960.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/uv_active4d.css" rel="stylesheet" type="text/css" />
		<link href="/static/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
	</head>
	<body class="api">
		<div id="header-wrapper">
			<div id="header">
				<div>
					<a class="logo" href="/">七牛云存储</a>
					<ul class="nav">
						<li><a href="https://portal.qiniu.com">开发者平台</a></li>
						<li><a href="http://www.qiniu.com">七牛官网</a></li>
						<!-- <li><a href="/faq/FAQ.html">FAQ</a></li> -->
					</ul>
				</div>
			</div><!-- #header -->
		</div><!-- #header-wrapper -->

		<div id="wrapper">
			<div class="content">	
				<h1>文件管理接口<span id="version">v6</span></h1>
				<article>
				<ul>
<li><a href="#words">术语</a></li>
<li><a href="#file">单文件操作</a>

<ul>
<li><a href="#stat">查看</a></li>
<li><a href="#move">移动</a></li>
<li><a href="#copy">复制</a></li>
<li><a href="#delete">删除</a></li>
</ul></li>
<li><a href="#batch">批量操作</a>

<ul>
<li><a href="#batch-stat">查看</a></li>
<li><a href="#batch-move">移动</a></li>
<li><a href="#batch-copy">复制</a></li>
<li><a href="#batch-delete">删除</a></li>
</ul></li>
<li><a href="#list">列出文件</a></li>
<li><a href="#digest-auth">授权认证 - AccessToken</a></li>
<li><a href="#error-code">错误码</a></li>
</ul>

<p><a name="words"></a></p>

<h2>术语</h2>

<p>在阅读下述API规格前，需要事先了解如下个别术语。</p>

<table>
<thead>
<tr>
<td>名称</td>
<td>说明</td>
</tr>
</thead>

<tbody>
<tr>
<td>AccessToken</td>
<td>令牌，API请求的访问凭证，参考 <a href="#digest-auth">授权认证 - AccessToken</a></td>
</tr>

<tr>
<td>EncodedEntryURI</td>
<td>代指要操作的资源，<code>EncodedEntryURI = urlsafe_base64_encode(bucket:key)</code></td>
</tr>

<tr>
<td>EncodedEntryURISrc</td>
<td>源 EncodedEntryURI</td>
</tr>

<tr>
<td>EncodedEntryURIDest</td>
<td>目标 EncodedEntryURI</td>
</tr>
</tbody>
</table>

<p><code>urlsafe_base64_encode(string)</code> 函数的实现符合 <a href="http://www.ietf.org/rfc/rfc4648.txt">RFC 4648</a> 标准，开发者可以参考 <a href="https://github.com/qiniu">github.com/qiniu</a> 上各SDK的样例代码。</p>

<p><a name="file"></a></p>

<h2>单文件操作</h2>

<p><a name="stat"></a></p>

<h3>查看</h3>

<pre><code>HTTP/1.1
POST http://rs.qbox.me/stat/&lt;EncodedEntryURI&gt;
Content-Type: application/x-www-form-urlencoded
Request Headers: {
    Authorization: QBox &lt;AccessToken&gt;
}

HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Response Body: {
    hash: &lt;FileETag string&gt;,
    fsize: &lt;FileSize int&gt;,
    putTime: &lt;PutTime int64&gt;, // 文件上传时候的七牛云存储服务器时间
    mimeType: &lt;MimeType string&gt;
}
</code></pre>

<p><a name="move"></a></p>

<h3>移动</h3>

<pre><code>HTTP/1.1
POST http://rs.qbox.me/move/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;
Content-Type: application/x-www-form-urlencoded
Request Headers: {
    Authorization: QBox &lt;AccessToken&gt;
}

HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
</code></pre>

<p><a name="copy"></a></p>

<h3>复制</h3>

<pre><code>HTTP/1.1
POST http://rs.qbox.me/copy/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;
Content-Type: application/x-www-form-urlencoded
Request Headers: {
    Authorization: QBox &lt;AccessToken&gt;
}

HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
</code></pre>

<p><a name="delete"></a></p>

<h3>删除</h3>

<pre><code>HTTP/1.1
POST http://rs.qbox.me/delete/&lt;EncodedEntryURI&gt;
Content-Type: application/x-www-form-urlencoded
Request Headers: {
    Authorization: QBox &lt;AccessToken&gt;
}

HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
</code></pre>

<p><a name="batch"></a></p>

<h2>批量操作</h2>

<p><strong>请求</strong></p>

<pre><code>POST http://rs.qbox.me/batch
Content-Type: application/x-www-form-urlencoded
RequestBody: op=&lt;Operation&gt;&amp;op=&lt;Operation&gt;&amp;...
</code></pre>

<p>其中 <code>op=&lt;Operation&gt;</code> 是一个操作指令。例如 <code>/get/</code>, <code>/stat/</code>, <code>/delete/</code>, …</p>

<p><a name="batch-stat"></a></p>

<h3>批量查看</h3>

<pre><code>POST http://rs.qbox.me/batch
Content-Type: application/x-www-form-urlencoded
RequestBody: op=/stat/&lt;EncodedEntryURI&gt;&amp;
             op=/stat/&lt;EncodedEntryURI&gt;&amp;
             ...
</code></pre>

<p><a name="batch-move"></a></p>

<h3>批量移动</h3>

<pre><code>POST http://rs.qbox.me/batch
Content-Type: application/x-www-form-urlencoded
RequestBody: op=/move/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;&amp;
             op=/move/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;&amp;
             ...
</code></pre>

<p><a name="batch-copy"></a></p>

<h3>批量复制</h3>

<pre><code>POST http://rs.qbox.me/batch
Content-Type: application/x-www-form-urlencoded
RequestBody: op=/copy/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;&amp;
             op=/copy/&lt;EncodedEntryURISrc&gt;/&lt;EncodedEntryURIDest&gt;&amp;
             ...
</code></pre>

<p><a name="batch-delete"></a></p>

<h3>批量删除</h3>

<pre><code>POST http://rs.qbox.me/batch
Content-Type: application/x-www-form-urlencoded
RequestBody: op=/delete/&lt;EncodedEntryURI&gt;&amp;
             op=/delete/&lt;EncodedEntryURI&gt;&amp;
             ...
</code></pre>

<p><strong>响应</strong></p>

<pre><code>200 OK [
    &lt;Result1&gt;, &lt;Result2&gt;, ...
]
298 Partial OK [
    &lt;Result1&gt;, &lt;Result2&gt;, ...
]

&lt;Result&gt; 是 {
    code: &lt;HttpCode int&gt;,
    data: &lt;Data&gt; 或 error: &lt;ErrorMessage string&gt;
}
</code></pre>

<p><a name="list"></a></p>

<h2>列出文件</h2>

<p>请求某个存储空间（bucket）下的文件列表，如果有前缀，可以按前缀（<code>prefix</code>）进行过滤；如果前一次返回<code>marker</code>就表示还有资源，下一步请求需要将<code>marker</code>参数填上。</p>

<pre><code>HTTP/1.1
POST http://rsf.qbox.me/list?bucket=&lt;BucketName&gt;&amp;
                             marker=&lt;Marker&gt;&amp;
                             limit=&lt;Limit&gt;&amp;
                             prefix=&lt;Prefix&gt;
Content-Type: application/x-www-form-urlencoded
Request Headers: {
    Authorization: QBox &lt;AccessToken&gt;
}

HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Response Body: {
    marker: &lt;Marker&gt; //如果没有剩余条目，服务器返回这项为空
    items: [
        {
            key：&lt;Key&gt;,
            time: &lt;FilePutTime&gt;,
            hash: &lt;FileETag&gt;,
            fsize: &lt;FileSize&gt;,
            mimeType: &lt;MimeType&gt;,
            customer: &lt;EndUserId&gt;
        },
        ...
    ]
}
</code></pre>

<p><strong>请求参数</strong></p>

<table>
<thead>
<tr>
<td>名称</td>
<td>必填项</td>
<td>说明</td>
</tr>
</thead>

<tbody>
<tr>
<td>bucket</td>
<td>是</td>
<td>存储空间名称</td>
</tr>

<tr>
<td>marker</td>
<td>否</td>
<td>为服务器上次导出时返回的标记，没有可以不填</td>
</tr>

<tr>
<td>limit</td>
<td>否</td>
<td>单次查询返回的最大条目数，最大不超过1000</td>
</tr>

<tr>
<td>prefix</td>
<td>否</td>
<td>指定要过滤出来的前缀</td>
</tr>
</tbody>
</table>

<p><a name="digest-auth"></a></p>

<h2>授权认证 - AccessToken</h2>

<p>生成 AccessToken 示例代码如下</p>

<p><strong>PHP</strong></p>

<pre><code>&lt;?php

/**
 * urlsafe_base64_encode
 *
 * @desc URL安全方式的base64编码
 * @param string $str
 * @return string
 */
function urlsafe_base64_encode($str){
    $find = array(&quot;+&quot;,&quot;/&quot;);
    $replace = array(&quot;-&quot;, &quot;_&quot;);
    return str_replace($find, $replace, base64_encode($str));
}

/**
 * generate_access_token
 *
 * @desc 生成 AccessToken
 * @param string $access_key
 * @param string $secret_key
 * @param string $url
 * @param array  $params
 * @return string
 */
function generate_access_token($access_key, $secret_key, $url, $params){
    $parsed_url = parse_url($url);
    $path = $parsed_url['path'];
    $access = $path;
    if (isset($parsed_url['query'])) {
        $access .= &quot;?&quot; . $parsed_url['query'];
    }
    $access .= &quot;\n&quot;;
    if($params){
        if (is_array($params)){
            $params = http_build_query($params);
        }
        $access .= $params;
    }
    $digest = hash_hmac('sha1', $access, $secret_key, true);
    return $access_key.':'.urlsafe_base64_encode($digest);
}

/**
 * 测试
 */
$access_key = 'YOUR_ACCESS_KEY';
$secret_key = 'YOUR_SECRET_KEY';
$url = 'http://rsf.qbox.me/list';
$params = array(
    &quot;bucket&quot; =&gt; &quot;myTestBucket&quot;,
    &quot;marker&quot; =&gt; 200,
    &quot;limit&quot;  =&gt; 100,
    &quot;prefix&quot; =&gt; &quot;&quot;,
);
$access_token = generate_access_token($access_key, $secret_key, $url, $params);
var_dump($access_token);
</code></pre>

<p><strong>Ruby</strong></p>

<pre><code>require 'rubygems'
require 'hmac-sha1'
require 'base64'
require 'uri'
require 'cgi'

def urlsafe_base64_encode content
    Base64.encode64(content).strip.gsub('+', '-').gsub('/','_').gsub(/\r?\n/, '')
end

def generate_access_token(access_key, secret_key, url, params)
    uri = URI.parse(url)
    access = uri.path
    query_string = uri.query
    access += '?' + query_string if !query_string.nil? &amp;&amp; !query_string.empty?
    access += &quot;\n&quot;;
    if params.is_a?(Hash)
        total_param = params.map do |key, value|
            %Q(#{CGI.escape(key.to_s)}=#{CGI.escape(value.to_s).gsub('+', '%20')})
        end
        access += total_param.join(&quot;&amp;&quot;)
    end
    hmac = HMAC::SHA1.new(secret_key)
    hmac.update(access)
    encoded_digest = urlsafe_base64_encode(hmac.digest)
    %Q(#{access_key}:#{encoded_digest})
end

access_key = 'YOUR_ACCESS_KEY_HERE'
secret_key = 'YOUR_SECRET_KEY_HERE'
url = 'http://rsf.qbox.me/list'
params = {
    &quot;bucket&quot; =&gt; &quot;myTestBucket&quot;,
    &quot;marker&quot; =&gt; 200,
    &quot;limit&quot;  =&gt; 100,
    &quot;prefix&quot; =&gt; &quot;&quot;,
}
access_token = generate_access_token(access_key, secret_key, url, params)
puts access_token
</code></pre>

<p><strong>请求认证</strong></p>

<p>将以上示例代码中签算的最终结果（<code>access_token</code>）附加到所在请求的 HTTP Headers 中即可。如下示例，在 HTTP Headers 中新增一个名为 Authorization 的字段，并将 <code>QBox access_token</code> 作为该字段的值：</p>

<pre><code>Authorization: QBox 3fPHl_SLkPXdioqI_A8_NGngPWVJhlDk2ktRjogH:6q3ojKAnANibjfQzUOxlYFXvGRk=
</code></pre>

<p>完整的授权认证示范代码可参考SDK实现，例如:</p>

<ul>
<li>Go - <a href="https://github.com/qiniu/api/blob/develop/auth/digest/digest_auth.go">https://github.com/qiniu/api/blob/develop/auth/digest/digest_auth.go</a></li>
<li>Python - <a href="https://github.com/qiniu/python-sdk/blob/develop/qiniu/auth_digest.py">https://github.com/qiniu/python-sdk/blob/develop/qiniu/auth_digest.py</a></li>
</ul>

<p><a name="error-code"></a></p>

<h2>错误码</h2>

<table>
<thead>
<tr>
<td>HTTP 状态码</td>
<td>错误说明</td>
</tr>
</thead>

<tbody>
<tr>
<td>400</td>
<td>请求参数错误</td>
</tr>

<tr>
<td>401</td>
<td>认证授权失败，可能是 AccessKey/SecretKey 错误或 AccessToken 无效</td>
</tr>

<tr>
<td>405</td>
<td>请求方式错误，非预期的请求方式</td>
</tr>

<tr>
<td>599</td>
<td>服务端操作失败</td>
</tr>

<tr>
<td>608</td>
<td>文件内容被修改</td>
</tr>

<tr>
<td>612</td>
<td>指定的文件不存在或已经被删除</td>
</tr>

<tr>
<td>614</td>
<td>文件已存在</td>
</tr>

<tr>
<td>631</td>
<td>指定的存储空间（Bucket）不存在</td>
</tr>
</tbody>
</table>

				</article>
			</div>

			<div id="js-sidebar" class="sidebar-shell">
				<div class="js-toggle-list sidebar-module expandable">
					<ul>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">新手上路</span></h3>
						<ul class="js-guides">
							<li><a href="/guide/testing.html">测试指南</a></li>
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">API</span></h3>
						<ul class="js-guides">
							<li><a href="/api/put.html">上传</a></li>
							<li><a href="/api/get.html">下载</a></li>
							<li><a href="/api/file-handle.html">文件管理</a></li>
							<li><a href="/api/image-process.html">图像处理</a></li>
							<li><a href="/api/audio-video-hls-process.html">音频/视频/流媒体处理</a></li>
							<li><a href="/api/qrcode.html">生成二维码 - QR code</a></li>
							<li><a href="/api/markdown-convert.html">Markdown 转 HTML</a></li>
							<li><a href="/api/pipeline.html">Pipeline API</a></li>
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">SDK</span></h3>
						<ul class="js-guides">
							<li><a href="/ios-sdk/index.html">Objective-C (iOS)</a></li>
							<li><a href="/android-sdk/index.html">Java (Android)</a></li>
							<li><a href="/java-sdk/index.html">Java</a></li>
							<li><a href="/php-sdk/index.html">PHP</a></li>
							<li><a href="/python-sdk/index.html">Python</a></li>
							<li><a href="/ruby-sdk/index.html">Ruby</a></li>
							<li><a href="/nodejs-sdk/index.html">Node.js</a></li>
							<li><a href="/csharp-sdk/index.html">C#</a></li>
							<li><a href="/c-sdk/index.html">C/C++</a></li>
							<li><a href="/go-sdk/index.html">Go</a></li>
							<li><a href="/perl-sdk/index.html">Perl</a></li>							
						</ul>
						</li>
						<li class="js-topic">
						<h3><a href="#" class="js-expand-btn expanded">&nbsp;</a><span class="spapi">上传及开发调试工具</span></h3>
						<ul class="js-guides">
							<li><a href="/tools/qrsync.html">qrsync</a></li>
							<li><a href="/tools/qboxrsctl.html">qboxrsctl</a></li>
							<li><a href="/tools/qiniu-autosync.html">qiniu-autosync</a></li>
						</ul>
						</li>
					</ul>
				</div> <!-- /sidebar-module -->
				<div class="sidebar-module">
					<p>帮助联系: <a href="mailto:support@qiniu.com">support@qiniu.com</a></p>
				</div>
			</div><!-- /sidebar-shell -->

		</div><!-- #wrapper -->

		<div id="footer" >
			<div class="lower_footer">
				<div class="footer_inner clearfix">
					<p>&copy; <span id="year">2012-2013</span> <a href="/">docs.qiniu.com</a>. All rights reserved. Powerd by <a href="http://www.qiniu.com" target="_blank">七牛云存储</a>. <a href="http://www.miibeian.gov.cn/" target="_blank">沪ICP备11037377号-2</a></p>
				</div><!-- /.site -->
			</div><!-- /.lower_footer -->
		</div><!-- /#footer -->

		<!-- <div class="popover fade top in"><div class="arrow"></div><h3 class="popover-title">文件管理接口</h3><div id="popover-content"></div></div> -->
		<script src="/static/js/jquery.js" type="text/javascript"></script>
		<script src="/static/js/qiniudoc.js" type="text/javascript"></script>
		<script src="/static/js/jquery.scrollUp.min.js"></script>
		<script type="text/javascript">
			   //var sdkName = "文件管理接口"
				 //$("#popover-content").html($("article ul")[0].outerHTML)
				 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
					})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

					ga('create', 'UA-40857860-3', 'qiniu.com');
					ga('send', 'pageview');
		 </script>
	 </body>
 </html>
